<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Examen Oral</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Un gris-verde muy claro */
        }
        /* Estilos para el spinner de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        /* Spinner más pequeño para respuestas */
        .answer-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para pestañas */
        .tab-button {
            transition: all 0.2s ease-in-out;
            border-bottom-width: 3px;
            border-color: transparent;
        }
        .tab-button.active {
            border-color: #2563eb; /* blue-600 */
            color: #1d4ed8; /* blue-700 */
        }
        /* Ocultar paneles de pestañas inactivas */
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        /* Estilos para el modal de error */
        #error-modal {
            transition: opacity 0.3s ease;
        }
        /* Estilos para la sección de respuestas */
        .answer-text {
            font-size: 0.9rem;
            color: #1f2937; /* gray-800 */
            background-color: #f9fafb; /* gray-50 */
            border-left: 4px solid #2563eb; /* blue-600 */
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: 0 4px 4px 0;
            white-space: pre-wrap; /* Mantiene saltos de línea y espacios */
        }
        .audio-player-container audio {
            width: 100%;
            height: 38px;
            margin-top: 8px;
        }
        /* Estilos para tarjetas de Q&A guardadas */
        .qa-card {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        .qa-card .question {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .qa-card .answer {
            font-size: 0.9rem;
            color: #4b5563;
            white-space: pre-wrap; /* Respeta saltos de línea */
            display: none; /* Oculta por defecto */
        }
        .qa-card .delete-qa-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .qa-card .delete-qa-btn:hover {
            background-color: #fecaca; /* red-200 */
            transform: scale(1.1);
        }
        /* Nuevos estilos para SRS */
        .qa-card .show-answer-btn {
            width: 100%;
            padding: 10px;
            font-weight: 500;
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            color: #1f2937;
            transition: background-color 0.2s;
        }
        .qa-card .show-answer-btn:hover {
            background-color: #e5e7eb;
        }
        .qa-card .rating-controls {
            display: none; /* Oculto hasta mostrar respuesta */
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 16px;
            border-top: 1px solid #e5e7eb;
            padding-top: 16px;
        }
        .qa-card .rate-btn {
            padding: 8px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid;
        }
        .rate-btn[data-rating="hard"] {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #b91c1c;
        }
        .rate-btn[data-rating="hard"]:hover { background-color: #fecaca; }
        
        .rate-btn[data-rating="good"] {
            background-color: #dbeafe;
            border-color: #93c5fd;
            color: #2563eb;
        }
        .rate-btn[data-rating="good"]:hover { background-color: #bfdbfe; }

        .rate-btn[data-rating="easy"] {
            background-color: #d1fae5;
            border-color: #a7f3d0;
            color: #065f46;
        }
        .rate-btn[data-rating="easy"]:hover { background-color: #a7f3d0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- NUEVO: Modal de ID de Sincronización -->
    <div id="sync-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800">Configurar Sincronización</h3>
            <p class="mt-3 text-base text-gray-600">
                Para sincronizar tus datos (materias, repasos) entre dispositivos, usa el mismo ID en todos ellos.
            </p>
            
            <div class="mt-6">
                <label for="sync-id-input" class="block text-sm font-medium text-gray-700">Pega tu ID de Sincronización existente:</label>
                <input type="text" id="sync-id-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="save-sync-id" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none">
                    Guardar y Usar este ID
                </button>
            </div>
            
            <div class="mt-6 border-t pt-4">
                <p class="text-gray-600">O si este es tu primer dispositivo:</p>
                <button id="generate-sync-id" class="mt-3 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 focus:outline-none">
                    Generar un Nuevo ID
                </button>
            </div>
        </div>
    </div>
    <!-- FIN MODAL -->

    <!-- Contenedor principal -->
    <div class="max-w-6xl mx-auto p-4 sm:p-8">
        
        <!-- Cabecera Mejorada -->
        <header class="mb-8 bg-white shadow-lg rounded-xl p-6 sm:p-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Simulador de Examen Oral</h1>
            <p class="text-lg text-gray-600">Entrena para tus exámenes con IA. Carga material, genera preguntas y guarda tus respuestas.</p>
            
            <!-- NUEVO: Selector de Materia -->
            <div class="mt-6 border-t border-gray-200 pt-4">
                <label for="subject-selector" class="block text-base font-semibold text-gray-800 mb-2">Materia Actual:</label>
                <div class="flex flex-col sm:flex-row sm:space-x-2">
                    <select id="subject-selector" class="w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="">-- Cargar Materia --</option>
                        <!-- Las materias se cargarán aquí -->
                    </select>
                    <input type="text" id="new-subject-name" placeholder="Nombre de nueva materia" class="mt-2 sm:mt-0 w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-subject-btn" class="mt-2 sm:mt-0 px-5 py-2.5 bg-gray-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all">
                        Crear
                    </button>
                </div>
            </div>
            <!-- FIN NUEVO -->
            
            <!-- Muestra el ID de usuario para colaboración (requerido) -->
            <div id="sync-id-display" class="mt-3 text-xs text-gray-500" style="display: none;">
                User ID (Sincronización): <span id="user-id" class="font-mono bg-gray-100 p-1 rounded">Cargando...</span>
            </div>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6">
            <nav class="flex space-x-4 sm:space-x-8 border-b border-gray-300" aria-label="Tabs">
                <button id="tab-material-btn" class="tab-button active whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Material
                </button>
                <button id="tab-simulador-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Simulador
                </button>
                <button id="tab-ranking-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Ranking
                </button>
                <button id="tab-review-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Repasar
                </button>
            </nav>
        </div>

        <!-- Contenido de las Pestañas -->
        <div class="bg-white shadow-xl rounded-xl p-6 sm:p-8">
            <!-- Pestaña 1: Cargar Material -->
            <div id="tab-material" class="tab-panel active space-y-6">
                <p class="text-base text-gray-600">
                    Pega tu material en las cajas de texto. El contenido se guarda en la nube y es acumulativo.
                </p>
                
                <div>
                    <label for="syllabus" class="block text-lg font-semibold text-gray-800 mb-2">Plan de Estudio / Temario</label>
                    <textarea id="syllabus" rows="8" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div>
                    <label for="theory" class="block text-lg font-semibold text-gray-800 mb-2">Teoría / Apuntes / Casos Clínicos</label>
                    <textarea id="theory" rows="12" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div>
                    <label for="experiences" class="block text-lg font-semibold text-gray-800 mb-2">Experiencias de Exámenes Orales</label>
                    <textarea id="experiences" rows="8" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <button id="save-material" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-blue-600 text-white text-base font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                    Guardar Material
                </button>
                <div id="save-status" class="text-green-600 text-base mt-2"></div>
            </div>

            <!-- Pestaña 2: Simular Examen -->
            <div id="tab-simulador" class="tab-panel space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                    <label for="questions-slider" class="block text-base font-medium text-gray-700">Preguntas por tema: <span id="questions-count" class="font-bold text-blue-600 text-lg">3</span></label>
                    <input id="questions-slider" type="range" min="1" max="5" value="3" class="w-full mt-2 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
                
                <button id="generate-exam" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-green-600 text-white text-base font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.25 12L17.437 14.846a4.5 4.5 0 00-3.09 3.09L12 20.75l.813-2.846a4.5 4.5 0 003.09-3.09L18.75 12l-2.846-.813a4.5 4.5 0 00-3.09-3.09L12 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L18.75 12z" /></svg>
                    Generar Simulación
                </button>
                
                <div id="exam-loader" class="loader" style="display: none;"></div>
                
                <div id="exam-output" class="min-h-[200px] space-y-4">
                    <p class="text-gray-500">Aquí aparecerán las preguntas generadas...</p>
                </div>
            </div>

            <!-- Pestaña 3: Ranking de Temas -->
            <div id="tab-ranking" class="tab-panel space-y-6">
                <p class="text-base text-gray-600">
                    La IA analizará todas las "Experiencias de Exámenes" para identificar los temas más frecuentes.
                </p>
                <button id="generate-ranking" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-indigo-600 text-white text-base font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
                    Analizar y Generar Ranking
                </button>
                
                <div id="ranking-loader" class="loader" style="display: none;"></div>
                
                <div id="ranking-output" class="bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200 min-h-[200px] whitespace-pre-wrap">
                    <p class="text-gray-500">Aquí aparecerá el ranking de temas...</p>
                </div>
            </div>

            <!-- Pestaña 4: Repasar Guardadas -->
            <div id="tab-review" class="tab-panel space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-base text-gray-600">
                        Preguntas programadas para repasar hoy.
                    </p>
                    <div class="text-right">
                        <p class="text-lg font-semibold text-blue-600">
                            <span id="review-due-count">0</span>
                            <span class="text-sm font-normal text-gray-500">para hoy</span>
                        </p>
                        <p class="text-xs text-gray-400">
                            (<span id="review-future-count">0</span> futuras)
                        </p>
                    </div>
                </div>
                <div id="review-loader" class="loader" style="display: none;"></div>
                <div id="review-output" class="min-h-[200px] space-y-8">
                    <p class="text-gray-500">Cargando preguntas guardadas...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal de Error -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none; opacity: 0;">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold text-red-600">Error</h3>
            <p id="error-message" class="mt-2 text-base text-gray-600"></p>
            <button id="close-modal" class="mt-6 w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:outline-none">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            setLogLevel,
            collection,
            addDoc,
            serverTimestamp,
            query,
            onSnapshot,
            deleteDoc,
            updateDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
 
        // --- VARIABLES GLOBALES ---
        let db, auth, appId, userId;
        let currentTab = 'tab-material';
        let currentSubject = ''; // NUEVO: Materia seleccionada
        let allSubjects = new Set(); // NUEVO: Lista de materias
        let savedQuestionsUnsubscribe = null; // Para el listener de onSnapshot
 
        // --- ELEMENTOS DEL DOM ---
        const tabButtons = {
            'tab-material': document.getElementById('tab-material-btn'),
            'tab-simulador': document.getElementById('tab-simulador-btn'),
            'tab-ranking': document.getElementById('tab-ranking-btn'),
            'tab-review': document.getElementById('tab-review-btn'),
        };
        const tabPanels = {
            'tab-material': document.getElementById('tab-material'),
            'tab-simulador': document.getElementById('tab-simulador'),
            'tab-ranking': document.getElementById('tab-ranking'),
            'tab-review': document.getElementById('tab-review'),
        };
        
        // Pestaña Material
        const syllabusText = document.getElementById('syllabus');
        const theoryText = document.getElementById('theory');
        const experiencesText = document.getElementById('experiences');
        const saveMaterialBtn = document.getElementById('save-material');
        const saveStatus = document.getElementById('save-status');
        
        // Pestaña Simulador
        const questionsSlider = document.getElementById('questions-slider');
        const questionsCount = document.getElementById('questions-count');
        const generateExamBtn = document.getElementById('generate-exam');
        const examLoader = document.getElementById('exam-loader');
        const examOutput = document.getElementById('exam-output');
        
        // Pestaña Ranking
        const generateRankingBtn = document.getElementById('generate-ranking');
        const rankingLoader = document.getElementById('ranking-loader');
        const rankingOutput = document.getElementById('ranking-output');

        // Pestaña Repasar
        const reviewLoader = document.getElementById('review-loader');
        const reviewOutput = document.getElementById('review-output');
        const reviewDueCount = document.getElementById('review-due-count');
        const reviewFutureCount = document.getElementById('review-future-count');
 
        // General
        const subjectSelector = document.getElementById('subject-selector'); // NUEVO
        const newSubjectName = document.getElementById('new-subject-name'); // NUEVO
        const addSubjectBtn = document.getElementById('add-subject-btn'); // NUEVO
        const userIdSpan = document.getElementById('user-id');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeModalBtn = document.getElementById('close-modal');

        // --- INICIALIZACIÓN DE FIREBASE ---
        
        function initializeFirebase() {
            try {
                // Esta es la configuración de tu proyecto de Firebase
                const firebaseConfig = {
                  apiKey: "AIzaSyAVbIeEAHBfKU5eDqsELTyXkAcM-m5qUUM",
                  authDomain: "simulador-examen-oral.firebaseapp.com",
                  projectId: "simulador-examen-oral",
                  storageBucket: "simulador-examen-oral.firebasestorage.app",
                  messagingSenderId: "64722873532",
                  appId: "1:64722873532:web:2f708ee4a62366598c34b9"
                };
                
                if (firebaseConfig.apiKey === "TU_API_KEY") {
                    showModal("Error de configuración: No has introducido tu configuración de Firebase en el archivo HTML. La app no funcionará.");
                    return;
                }

                // Usamos el ID del proyecto como App ID, o puedes poner un string fijo
                appId = firebaseConfig.projectId || 'oral-exam-sim';

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Habilitar logs para depuración

                setupAuth();
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                showModal("No se pudo conectar con la base de datos. Por favor, refresca la página.");
            }
        }

        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // La autenticación anónima (user.uid) funcionó.
                    // Ahora, buscamos el ID de SINCRONIZACIÓN (datos).
                    
                    let syncId = localStorage.getItem('my_sync_userId');
                    
                    if (syncId) {
                        // ¡Perfecto! Ya tenemos un ID de sincronización guardado.
                        userId = syncId; // Usamos este ID para TODAS las rutas de datos.
                        userIdSpan.textContent = userId;
                        
                        document.getElementById('sync-id-display').style.display = 'block';
                        document.getElementById('sync-modal').style.display = 'none';

                        // Cargar lista de materias
                        await loadUserSubjects(); 
                        // Configurar listeners de UI
                        setupUIListeners();
                        
                    } else {
                        // Es la primera vez en este dispositivo o se borró el localStorage.
                        // Mostramos el modal para que elija.
                        document.getElementById('sync-id-display').style.display = 'none';
                        document.getElementById('sync-modal').style.display = 'flex';
                    }
                    
                } else {
                    // Usuario no autenticado (raro, pero podría pasar)
                    console.log("Usuario no autenticado.");
                }
            });

            try {
                // Para GitHub Pages, SIEMPRE usamos autenticación anónima.
                // Esto es solo para cumplir la regla de seguridad "request.auth != null".
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error de autenticación:", error);
                showModal("Error de autenticación. La app no funcionará.");
            }
        }

        // --- LÓGICA DE UI (PESTAÑAS Y MODAL) ---

        function switchTab(newTabId) {
            currentTab = newTabId;
            
            Object.keys(tabButtons).forEach(tabId => {
                const btn = tabButtons[tabId];
                const panel = tabPanels[tabId];
                
                if (tabId === newTabId) {
                    btn.classList.add('active');
                    panel.classList.add('active');
                } else {
                    btn.classList.remove('active');
                    panel.classList.remove('active');
                }
            });
        }

        function showModal(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
            setTimeout(() => errorModal.style.opacity = 1, 10);
        }

        function hideModal() {
            errorModal.style.opacity = 0;
            setTimeout(() => errorModal.style.display = 'none', 300);
        }

        function setupUIListeners() {
            // Navegación de pestañas
            Object.keys(tabButtons).forEach(tabId => {
                tabButtons[tabId].addEventListener('click', () => switchTab(tabId));
            });
            
            // Modal
            closeModalBtn.addEventListener('click', hideModal);
            
            // NUEVO: Listeners de Materia
            addSubjectBtn.addEventListener('click', handleAddSubject);
            subjectSelector.addEventListener('change', handleSubjectChange);
            
            // Pestaña Material
            saveMaterialBtn.addEventListener('click', handleSaveMaterial);
            
            // Pestaña Simulador
            questionsSlider.addEventListener('input', (e) => {
                questionsCount.textContent = e.target.value;
            });
            generateExamBtn.addEventListener('click', handleGenerateExam);
            // Listener unificado para botones de "Responder" y "Guardar"
            examOutput.addEventListener('click', (e) => {
                if (e.target.closest('.answer-btn')) {
                    handleAnswerClick(e.target.closest('.answer-btn'));
                }
                if (e.target.closest('.save-btn')) {
                    handleSaveClick(e.target.closest('.save-btn'));
                }
            });
            
            // Pestaña Ranking
            generateRankingBtn.addEventListener('click', handleGenerateRanking);

            // Pestaña Repasar
            reviewOutput.addEventListener('click', (e) => {
                if (e.target.closest('.delete-qa-btn')) {
                    handleDeleteClick(e.target.closest('.delete-qa-btn'));
                }
                // Nuevos listeners para Anki
                if (e.target.closest('.show-answer-btn')) {
                    handleShowAnswerClick(e.target.closest('.show-answer-btn'));
                }
                if (e.target.closest('.rate-btn')) {
                    handleRateClick(e.target.closest('.rate-btn'));
                }
            });
        }
        
        // --- NUEVAS FUNCIONES PARA MANEJO DE MATERIAS ---

        /**
         * Carga la lista de materias del usuario desde Firestore.
         */
        async function loadUserSubjects() {
            if (!userId) return;
            const subjectsRef = collection(db, 'artifacts', appId, 'users', userId, 'subjects');
            try {
                const querySnapshot = await getDocs(subjectsRef);
                allSubjects = new Set();
                querySnapshot.forEach((doc) => {
                    allSubjects.add(doc.id); // El ID del doc es el nombre de la materia
                });
                renderSubjectSelector();
            } catch (error) {
                console.error("Error cargando materias:", error);
                showModal("No se pudieron cargar tus materias.");
            }
        }

        /**
         * Rellena el <select> de materias.
         */
        function renderSubjectSelector() {
            subjectSelector.innerHTML = '<option value="">-- Selecciona una Materia --</option>';
            allSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelector.appendChild(option);
            });
        }

        /**
         * Maneja el clic para crear una nueva materia.
         */
        async function handleAddSubject() {
            const newSubject = newSubjectName.value.trim();
            if (!newSubject) {
                showModal("El nombre de la materia no puede estar vacío.");
                return;
            }
            if (allSubjects.has(newSubject)) {
                showModal("Esa materia ya existe.");
                return;
            }

            try {
                // Crear un doc placeholder para que la materia "exista"
                const subjectDocRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', newSubject);
                await setDoc(subjectDocRef, { createdAt: serverTimestamp() });
                
                allSubjects.add(newSubject);
                renderSubjectSelector();
                subjectSelector.value = newSubject;
                newSubjectName.value = '';
                
                // Disparar el cambio de materia
                handleSubjectChange(); 

            } catch (error) {
                console.error("Error creando materia:", error);
                showModal("No se pudo crear la materia.");
            }
        }

        /**
         * Se dispara cuando el usuario cambia la materia en el <select>.
         */
        async function handleSubjectChange() {
            currentSubject = subjectSelector.value;
            if (!currentSubject) {
                clearMaterialUI();
                clearReviewUI();
                return;
            }
            
            // Ahora que tenemos materia, cargamos todo
            await loadMaterialFromFirestore();
            setupSavedQuestionsListener(); // Esto se reconfigura y se dispara
        }

        /**
         * Limpia los textareas de material.
         */
        function clearMaterialUI() {
            syllabusText.value = '';
            theoryText.value = '';
            experiencesText.value = '';
            saveStatus.textContent = '';
        }

        /**
         * Limpia la pestaña de repaso y detiene el listener.
         */
        function clearReviewUI() {
            if (savedQuestionsUnsubscribe) {
                savedQuestionsUnsubscribe();
                savedQuestionsUnsubscribe = null;
            }
            reviewOutput.innerHTML = '<p class="text-gray-500">Selecciona una materia para ver las preguntas.</p>';
            reviewDueCount.textContent = '0';
            reviewFutureCount.textContent = '0';
        }


        // --- LÓGICA DE FIRESTORE (MATERIAL) ---

        async function getMaterialRef(materialType) {
            if (!userId) {
                showModal("Usuario no autenticado. No se puede operar.");
                return null;
            }
            if (!currentSubject) {
                console.warn("Intento de acceso a material sin materia seleccionada.");
                return null;
            }
            // La ruta ahora incluye la materia
            return doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'materials', materialType);
        }

        async function handleSaveMaterial() {
            if (!currentSubject) {
                showModal("Por favor, selecciona o crea una materia primero.");
                return;
            }
            saveStatus.textContent = "Guardando...";
            saveMaterialBtn.disabled = true;

            try {
                const materialsToSave = [
                    { id: 'syllabus', content: syllabusText.value },
                    { id: 'theory', content: theoryText.value },
                    { id: 'experiences', content: experiencesText.value }
                ];
                
                for (const mat of materialsToSave) {
                    const docRef = await getMaterialRef(mat.id);
                    if(docRef) {
                        await setDoc(docRef, { content: mat.content });
                    }
                }
                
                saveStatus.textContent = "¡Material guardado en la nube exitosamente!";
                setTimeout(() => saveStatus.textContent = "", 3000);

            } catch (error) {
                console.error("Error al guardar:", error);
                showModal(`Error al guardar material: ${error.message}`);
                saveStatus.textContent = "Error al guardar.";
            } finally {
                saveMaterialBtn.disabled = false;
            }
        }
        
        async function loadMaterialFromFirestore() {
            if (!currentSubject) {
                clearMaterialUI();
                return;
            }
            try {
                const materialsToLoad = [
                    { id: 'syllabus', element: syllabusText },
                    { id: 'theory', element: theoryText },
                    { id: 'experiences', element: experiencesText }
                ];

                for (const mat of materialsToLoad) {
                    const docRef = await getMaterialRef(mat.id);
                    if(!docRef) continue;
                    
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        mat.element.value = docSnap.data().content || "";
                    } else {
                        mat.element.value = "";
                    }
                }
            } catch (error) {
                console.error("Error al cargar:", error);
                showModal(`No se pudo cargar el material guardado: ${error.message}`);
            }
        }

        async function getAllMaterials() {
            let materials = {
                syllabus: "",
                theory: "",
                experiences: ""
            };
            try {
                const syllabusRef = await getMaterialRef('syllabus');
                const theoryRef = await getMaterialRef('theory');
                const experiencesRef = await getMaterialRef('experiences');

                if(syllabusRef) {
                    const syllabusSnap = await getDoc(syllabusRef);
                    if (syllabusSnap.exists()) materials.syllabus = syllabusSnap.data().content;
                }
                
                if(theoryRef) {
                    const theorySnap = await getDoc(theoryRef);
                    if (theorySnap.exists()) materials.theory = theorySnap.data().content;
                }

                if(experiencesRef) {
                    const experiencesSnap = await getDoc(experiencesRef);
                    if (experiencesSnap.exists()) materials.experiences = experiencesSnap.data().content;
                }
                
                return materials;
            } catch (error) {
                console.error("Error al obtener materiales:", error);
                showModal("Error al leer los materiales de la base de datos.");
                return null;
            }
        }

        // --- LÓGICA DE IA (GEMINI API) ---
        
        async function callGemini(systemPrompt, userQuery, generationConfig = null) {
            // --- ¡IMPORTANTE! ---
            // Clave API integrada
            const apiKey = "AIzaSyA1RYWX9v5UFVVGVcI9KKyPXK3BDnIRkqw"; // Clave API integrada
            // --- FIN ---

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            if (generationConfig) {
                payload.generationConfig = generationConfig;
            }

            let response;
            let retries = 0;
            const maxRetries = 3;

            while (retries < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            throw new Error("Respuesta de la IA inválida o vacía.");
                        }
                    } else {
                        // --- INICIO DE LA MEJORA DE ERROR ---
                        const errorBody = await response.text();
                        console.error(`Error ${response.status} en callGemini:`, errorBody);
                        let specificError = errorBody;
                        try {
                            const errorJson = JSON.parse(errorBody);
                            specificError = errorJson.error?.message || errorBody;
                        } catch (e) { /* No era JSON */ }
                        throw new Error(`Error en API Gemini (${response.status}): ${specificError}`);
                        // --- FIN DE LA MEJORA DE ERROR ---
                    }
                } catch (error) {
                    console.error(`Intento ${retries + 1} fallido (callGemini):`, error);
                    retries++;
                    if (retries >= maxRetries) {
                        throw error; // Lanza el error final después de todos los intentos
                    }
                    const delay = Math.pow(2, retries) * 1000; // 1s, 2s, 4s
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- FUNCIONES DE TTS (TEXT-TO-SPEECH) ---
        async function callGeminiTTS(textToSpeak) {
            // --- ¡IMPORTANTE! ---
            // Clave API integrada
            const apiKey = "AIzaSyA1RYWX9v5UFVVGVcI9KKyPXK3BDnIRkqw"; // Clave API integrada
            // --- FIN ---

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: `Di con tono claro e informativo: ${textToSpeak}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } 
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // --- INICIO DE LA MEJORA DE ERROR ---
                    const errorBody = await response.text();
                    console.error(`Error ${response.status} en callGeminiTTS:`, errorBody);
                    let specificError = errorBody;
                    try {
                        const errorJson = JSON.parse(errorBody);
                        specificError = errorJson.error?.message || errorBody;
                    } catch (e) { /* No era JSON */ }
                    throw new Error(`Error en API TTS (${response.status}): ${specificError}`);
                    // --- FIN DE LA MEJORA DE ERROR ---
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    return { audioData, mimeType };
                } else {
                    throw new Error("Respuesta de audio TTS inválida o no encontrada.");
                }
            } catch (error) {
                console.error("Error en callGeminiTTS:", error);
                throw error;
            }
        }
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);
            const pcm16 = new Int16Array(pcmData);
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        async function playAudio(audioData, mimeType, playerContainer) {
            try {
                const rateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                playerContainer.innerHTML = '';
                const audio = document.createElement('audio');
                audio.src = audioUrl;
                audio.controls = true;
                playerContainer.appendChild(audio);
                audio.play();
            } catch (error) {
                console.error("Error al reproducir audio:", error);
                playerContainer.textContent = "Error al procesar audio.";
            }
        }
        
        // --- FUNCIÓN PARA OBTENER RESPUESTA DE IA ---
        
        async function getAnswerForQuestion(question, materials) {
            // --- INICIO DE LA MODIFICACIÓN ---
            const systemPrompt = "Eres un profesor experto. Responde la siguiente pregunta de examen de forma concisa y directa, basándote en el material de estudio proporcionado. La respuesta debe ser ideal para un examen oral. IMPORTANTE: Para resaltar texto clave, usa las etiquetas HTML <b> y </b>. No utilices ningún otro formato como Markdown (`**`).";
            // --- FIN DE LA MODIFICACIÓN ---
            const userQuery = `
                Material de Estudio (Contexto):
                --- PLAN DE ESTUDIO ---
                ${materials.syllabus || "No proporcionado."}
                --- TEORÍA Y CASOS CLÍNICOS ---
                ${materials.theory || "No proporcionado."}
                --- EXPERIENCIAS PASADAS ---
                ${materials.experiences || "No proporcionado."}
                --- FIN DEL MATERIAL ---

                Pregunta a responder:
                "${question}"

                Por favor, genera una respuesta clara y concisa para esta pregunta.
            `;
            try {
                const answer = await callGemini(systemPrompt, userQuery);
                return answer;
            } catch (error) {
                console.error("Error en getAnswerForQuestion:", error);
                throw error; // Re-lanzar el error para que handleAnswerClick lo atrape
            }
        }


        // --- MANEJADORES DE EVENTOS PRINCIPALES ---
        
        async function handleGenerateExam() {
            examLoader.style.display = 'block';
            generateExamBtn.disabled = true;
            examOutput.innerHTML = "<p>Generando preguntas... Esto puede tardar un momento.</p>";

            const materials = await getAllMaterials();
            if (!materials) {
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
                return;
            }
            
            if (!currentSubject) {
                 showModal("Por favor, selecciona una materia primero.");
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
                examOutput.innerHTML = "<p class='text-gray-500'>Aquí aparecerán las preguntas generadas...</p>";
                return;
            }

            if (!materials.syllabus && !materials.theory && !materials.experiences) {
                showModal("No hay material cargado para esta materia. Por favor, ve a la pestaña 'Material' y guarda contenido primero.");
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
                examOutput.innerHTML = "<p class='text-gray-500'>Aquí aparecerán las preguntas generadas...</p>";
                return;
            }

            const questionsPerTopic = questionsSlider.value;
            const systemPrompt = "Eres un asistente experto en educación que simula un examen oral. Tu tarea es generar preguntas para un examen oral basándote en el material. Debes devolver un objeto JSON.";
            const jsonSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "tema": { "type": "STRING" },
                        "preguntas": {
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        }
                    },
                    "required": ["tema", "preguntas"]
                }
            };
            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: jsonSchema
            };
            const userQuery = `
                Basado en los siguientes materiales:
                --- PLAN DE ESTUDIO ---
                ${materials.syllabus || "No proporcionado."}
                --- TEORÍA Y CASOS CLÍNICOS ---
                ${materials.theory || "No proporcionado."}
                --- EXPERIENCIAS PASADAS ---
                ${materials.experiences || "No proporcionado."}
                --- FIN EXPERIENCIAS ---
                Genera una simulación de examen oral. Sigue estas reglas:
                1. Identifica 3 (tres) temas principales distintos.
                2. Para CADA uno de los 3 temas, genera exactamente ${questionsPerTopic} preguntas cortas, directas y concisas.
                3. Si el material incluye "casos clínicos", intenta que una pregunta sea un caso clínico breve.
                4. Responde ÚNICAMENTE con el array JSON que cumple el esquema.
            `;

            try {
                const resultText = await callGemini(systemPrompt, userQuery, generationConfig);
                const examData = JSON.parse(resultText);
                renderExamUI(examData);
            } catch (error) {
                console.error("Error al generar examen:", error);
                showModal(`Error al comunicarse con la IA o procesar su respuesta: ${error.message}`);
                examOutput.innerHTML = "<p>Ocurrió un error al generar las preguntas.</p>";
            } finally {
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
            }
        }

        function renderExamUI(examData) {
            examOutput.innerHTML = ''; // Limpiar
            if (!examData || examData.length === 0) {
                examOutput.textContent = "No se pudieron generar preguntas.";
                return;
            }

            examData.forEach((topic, index) => {
                const topicEl = document.createElement('div');
                topicEl.className = 'mb-6 p-4 border rounded-xl bg-gray-50 shadow-inner';
                
                const topicTitle = document.createElement('h3');
                topicTitle.className = 'text-xl font-bold text-blue-800 mb-4';
                topicTitle.textContent = `Tema ${index + 1}: ${topic.tema}`;
                topicEl.appendChild(topicTitle);

                topic.preguntas.forEach((question) => {
                    const qContainer = document.createElement('div');
                    qContainer.className = 'question-item border-t border-gray-200 py-4';
                    
                    const qText = document.createElement('p');
                    qText.className = 'text-gray-800 font-semibold text-base';
                    qText.textContent = question;
                    
                    const qButton = document.createElement('button');
                    qButton.className = 'answer-btn mt-3 px-4 py-1.5 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition-colors inline-flex items-center';
                    qButton.innerHTML = `<svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                        Responder y Escuchar`;
                    qButton.dataset.question = question;

                    const saveButton = document.createElement('button');
                    saveButton.className = 'save-btn mt-3 ml-2 px-4 py-1.5 bg-green-500 text-white text-sm font-medium rounded-md hover:bg-green-600 transition-colors inline-flex items-center';
                    saveButton.innerHTML = `<svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0111.186 0zM17.593 3.322c.107.014.215.026.32.04a48.196 48.196 0 00-11.83 0c.105-.014.213-.026.32-.04m11.19 0A48.25 48.25 0 0012 3c-2.755 0-5.459.436-8.093 1.1262M12 12v3.75m0-9.75v.01" /></svg>
                        Guardar`;
                    saveButton.dataset.question = question;
                    saveButton.dataset.topic = topic.tema;
                    saveButton.style.display = 'none'; // Oculto hasta que haya respuesta

                    const loader = document.createElement('div');
                    loader.className = 'answer-loader';
                    loader.style.display = 'none';
                    
                    const answerTextEl = document.createElement('p');
                    answerTextEl.className = 'answer-text';
                    answerTextEl.style.display = 'none';

                    const audioPlayerContainer = document.createElement('div');
                    audioPlayerContainer.className = 'audio-player-container';

                    qContainer.appendChild(qText);
                    qContainer.appendChild(qButton);
                    qContainer.appendChild(saveButton);
                    qButton.appendChild(loader);
                    qContainer.appendChild(answerTextEl);
                    qContainer.appendChild(audioPlayerContainer);
                    topicEl.appendChild(qContainer);
                });

                examOutput.appendChild(topicEl);
            });
        }
        
        async function handleAnswerClick(button) {
            const question = button.dataset.question;
            const container = button.closest('.question-item');
            const loader = button.querySelector('.answer-loader');
            const answerTextEl = container.querySelector('.answer-text');
            const audioPlayerContainer = container.querySelector('.audio-player-container');
            const saveButton = container.querySelector('.save-btn'); 

            button.disabled = true;
            loader.style.display = 'inline-block';
            answerTextEl.style.display = 'none';
            // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
            answerTextEl.innerHTML = 'Generando respuesta...';
            audioPlayerContainer.innerHTML = '';
            saveButton.style.display = 'none'; 

            try {
                const materials = await getAllMaterials();
                if (!materials) throw new Error("No se pudo cargar el material de contexto.");
                
                answerTextEl.style.display = 'block';
                const answerText = await getAnswerForQuestion(question, materials);
                // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
                answerTextEl.innerHTML = answerText;

                // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
                answerTextEl.innerHTML += "\n\nGenerando audio...";
                const { audioData, mimeType } = await callGeminiTTS(answerText.replace(/<b>/g, '').replace(/<\/b>/g, '')); // Quitar HTML para el audio
                
                // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
                answerTextEl.innerHTML = answerText; // Restaurar texto limpio con HTML
                await playAudio(audioData, mimeType, audioPlayerContainer);

                saveButton.dataset.answer = answerText;
                saveButton.style.display = 'inline-flex'; 
                saveButton.disabled = false;
                saveButton.innerHTML = `<svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0111.186 0zM17.593 3.322c.107.014.215.026.32.04a48.196 48.196 0 00-11.83 0c.105-.014.213-.026.32-.04m11.19 0A48.25 48.25 0 0012 3c-2.755 0-5.459.436-8.093 1.262M12 12v3.75m0-9.75v.01" /></svg>
                        Guardar`;

            } catch (error) {
                console.error("Error en handleAnswerClick:", error);
                // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
                answerTextEl.innerHTML = `Error: ${error.message}`; 
                answerTextEl.style.display = 'block';
            } finally {
                button.disabled = false;
                loader.style.display = 'none';
            }
        }

        // --- FUNCIONES PARA GUARDAR Y REPASAR ---

        async function handleSaveClick(button) {
            const topic = button.dataset.topic;
            const question = button.dataset.question;
            const answer = button.dataset.answer;

            if (!currentSubject) {
                showModal("Por favor, selecciona una materia antes de guardar.");
                return;
            }

            if (!topic || !question || !answer) {
                showModal("Error: no se pudo obtener la información para guardar.");
                return;
            }

            button.disabled = true;
            button.innerHTML = "Guardando...";

            try {
                const savedQuestionsRef = collection(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions');
                
                await addDoc(savedQuestionsRef, {
                    topic: topic,
                    question: question,
                    answer: answer,
                    createdAt: serverTimestamp(),
                    reviewStep: 0,
                    nextReviewDate: serverTimestamp()
                });

                button.innerHTML = "¡Guardado!";

            } catch (error) {
                console.error("Error al guardar Q&A:", error);
                showModal(`No se pudo guardar la pregunta: ${error.message}`);
                button.disabled = false;
                button.innerHTML = "Reintentar Guardar";
            }
        }

        function setupSavedQuestionsListener() {
            if (savedQuestionsUnsubscribe) {
                savedQuestionsUnsubscribe(); 
            }
            if (!userId || !currentSubject) {
                clearReviewUI();
                return;
            }

            reviewLoader.style.display = 'block';
            reviewOutput.innerHTML = '';

            const q = query(collection(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions'));
            
            savedQuestionsUnsubscribe = onSnapshot(q, (snapshot) => {
                reviewLoader.style.display = 'none';
                
                const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const now = new Date();

                const dueDocs = docs.filter(doc => {
                    return doc.nextReviewDate && doc.nextReviewDate.toDate() <= now;
                });
                
                dueDocs.sort((a, b) => (a.nextReviewDate?.toMillis() || 0) - (b.nextReviewDate?.toMillis() || 0));

                const futureDocsCount = docs.length - dueDocs.length;
                
                reviewDueCount.textContent = dueDocs.length;
                reviewFutureCount.textContent = futureDocsCount;

                if (dueDocs.length === 0) {
                    reviewOutput.innerHTML = '<p class="text-gray-500">¡Todo repasado por hoy! Vuelve más tarde.</p>';
                    return;
                }
                
                const groupedByTopic = dueDocs.reduce((acc, doc) => {
                    const topic = doc.topic || 'Sin Tema';
                    if (!acc[topic]) {
                        acc[topic] = [];
                    }
                    acc[topic].push(doc); 
                    return acc; 
                }, {}); 

                renderSavedQuestions(groupedByTopic);

            }, (error) => { 
                console.error("Error en listener de 'Repasar':", error);
                reviewLoader.style.display = 'none';
                reviewOutput.innerHTML = '<p class="text-red-500">Error al cargar las preguntas guardadas.</p>';
             });
         }

        function renderSavedQuestions(groupedByTopic) {
            reviewOutput.innerHTML = '';
            
            const sortedTopics = Object.keys(groupedByTopic).sort();

            for (const topic of sortedTopics) {
                const topicGroupEl = document.createElement('div');
                topicGroupEl.className = 'topic-group';

                const topicTitle = document.createElement('h3');
                topicTitle.className = 'text-2xl font-semibold text-gray-800 mb-4 border-b border-gray-300 pb-2';
                topicTitle.textContent = topic;
                topicGroupEl.appendChild(topicTitle);
                
                groupedByTopic[topic].forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'qa-card';
                    card.dataset.id = doc.id;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-qa-btn';
                    deleteBtn.dataset.id = doc.id;
                    deleteBtn.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.502 0c-.34.052-.68.107-1.022.166m11.48 0c.342.052.682.107 1.022.166m-5.462 0a48.108 48.108 0 00-3.478-.397m-1.246 0A48.258 48.258 0 0012 3c-1.37 0-2.714.098-4.022.282m0 0C7.644 3.37 6.64 3.655 5.752 4.043" /></svg>';
                    
                    const questionP = document.createElement('p');
                    questionP.className = 'question';
                    questionP.textContent = doc.question;
                    
                    const answerP = document.createElement('p');
                    answerP.className = 'answer';
                    // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
                    answerP.innerHTML = doc.answer;
                    
                    const showAnswerBtn = document.createElement('button');
                    showAnswerBtn.className = 'show-answer-btn';
                    showAnswerBtn.textContent = 'Mostrar Respuesta';
                    
                    const ratingControls = document.createElement('div');
                    ratingControls.className = 'rating-controls';
                    ratingControls.innerHTML = `
                        <button class="rate-btn" data-rating="hard" data-step="${doc.reviewStep || 0}" data-id="${doc.id}">Difícil</button>
                        <button class="rate-btn" data-rating="good" data-step="${doc.reviewStep || 0}" data-id="${doc.id}">Bien</button>
                        <button class="rate-btn" data-rating="easy" data-step="${doc.reviewStep || 0}" data-id="${doc.id}">Fácil</button>
                    `;

                    card.appendChild(deleteBtn);
                    card.appendChild(questionP);
                    card.appendChild(answerP); 
                    card.appendChild(ratingControls);
                    card.appendChild(showAnswerBtn); 
                    topicGroupEl.appendChild(card);
                });

                reviewOutput.appendChild(topicGroupEl);
            }
        }

        async function handleDeleteClick(button) {
            const id = button.dataset.id;
            if (!id) return;
            
            button.disabled = true;
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions', id);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error al borrar Q&A:", error);
                showModal(`No se pudo borrar la pregunta: ${error.message}`);
                button.disabled = false;
            }
        }

        function handleShowAnswerClick(button) {
            const card = button.closest('.qa-card');
            if (!card) return;

            card.querySelector('.answer').style.display = 'block';
            card.querySelector('.rating-controls').style.display = 'grid';
            button.style.display = 'none';
        }

        function getNextReview(currentStep, rating) {
            const intervals = [1, 3, 7, 15, 30, 60, 120]; 
            let nextStep;

            if (rating === 'hard') {
                nextStep = 0;
            } else if (rating === 'good') {
                nextStep = currentStep + 1;
            } else { // easy
                nextStep = currentStep + 2;
            }

            const now = new Date();
            let nextReviewDate = new Date();

            if (nextStep === 0) {
                nextReviewDate.setMinutes(now.getMinutes() + 10);
            } else {
                const daysToAdd = intervals[Math.min(nextStep - 1, intervals.length - 1)];
                nextReviewDate.setDate(now.getDate() + daysToAdd);
            }

            return { nextStep, nextReviewDate };
        }

        async function handleRateClick(button) {
            const id = button.dataset.id;
            const rating = button.dataset.rating;
            const currentStep = parseInt(button.dataset.step) || 0;
            const card = button.closest('.qa-card');

            if (!id || !rating) return;
            
            card.style.opacity = '0.5';

            try {
                const { nextStep, nextReviewDate } = getNextReview(currentStep, rating);
                
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions', id);
                await updateDoc(docRef, {
                    reviewStep: nextStep,
                    nextReviewDate: nextReviewDate
                });

            } catch (error) {
                console.error("Error al actualizar la tarjeta de repaso:", error);
                showModal(`Error al guardar tu progreso: ${error.message}`);
                card.style.opacity = '1';
            }
        }
        
         async function handleGenerateRanking() {
            rankingLoader.style.display = 'block';
            generateRankingBtn.disabled = true;
            // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
            rankingOutput.innerHTML = "Analizando experiencias...";

            const materials = await getAllMaterials();
            if (!materials) {
                rankingLoader.style.display = 'none';
                generateRankingBtn.disabled = false;
                return;
            }

            // --- INICIO DE LA MODIFICACIÓN ---
            const systemPrompt = "Eres un asistente de análisis de datos educativos. Tu trabajo es analizar transcripciones de experiencias de exámenes orales y encontrar patrones de frecuencia. IMPORTANTE: Para resaltar texto clave, usa las etiquetas HTML <b> y </b>. No utilices ningún otro formato como Markdown (`**`).";
            // --- FIN DE LA MODIFICACIÓN ---
            
            const userQuery = `
                Analiza las siguientes experiencias de exámenes orales:
                --- EXPERIENCIAS PASADAS ---
                ${materials.experiences}
                --- FIN EXPERIENCIAS ---
                --- PLAN DE ESTUDIO (para contexto de nombres de temas) ---
                ${materials.syllabus || "No proporcionado."}
                --- FIN PLAN DE ESTUDIO ---
                Tu tarea es identificar y generar un ranking de los temas preguntados con MÁS frecuencia.
                La lista debe ser clara, ordenada y concisa, del tema más frecuente al menos frecuente.
                Devuelve solo la lista ordenada.
            `;

            try {
                const result = await callGemini(systemPrompt, userQuery);
                // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
                rankingOutput.innerHTML = result;
            } catch (error) {
                console.error("Error al generar ranking:", error);
                showModal(`Error al comunicarse con la IA: ${error.message}`);
                // --- MODIFICACIÓN: Usar innerHTML para permitir negritas ---
                rankingOutput.innerHTML = "Ocurrió un error al generar el ranking.";
            } finally {
                rankingLoader.style.display = 'none';
                generateRankingBtn.disabled = false;
            }
        }

        // --- INICIAR LA APLICACIÓN ---
        initializeFirebase();

        // --- LISTENERS DEL MODAL DE SINCRONIZACIÓN (¡CORREGIDO!) ---
        // Estos listeners deben estar activos SIEMPRE, no solo después del login.
        document.getElementById('save-sync-id').addEventListener('click', () => {
            const inputId = document.getElementById('sync-id-input').value.trim();
            if (inputId) {
                localStorage.setItem('my_sync_userId', inputId);
                window.location.reload(); // Recargar para aplicar el ID
            } else {
                showModal("Por favor, introduce un ID válido.");
            }
        });
        
        document.getElementById('generate-sync-id').addEventListener('click', () => {
            const newId = crypto.randomUUID(); // Genera un ID único
            localStorage.setItem('my_sync_userId', newId);
            window.location.reload(); // Recargar para aplicar el ID
        });

    </script>
</body>
</html>
